version: '3.8'

# Minimal stack for CI - fast, reliable, essential services only
# Usage: docker-compose -f docker-compose.minimal.yml up

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: rapidfab
      POSTGRES_PASSWORD: rapidfab-dev
      POSTGRES_DB: rapidfab
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rapidfab"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # RapidFab API
  api:
    build:
      context: ./services/api
      dockerfile: Containerfile
    environment:
      - DATABASE_URL=postgres://rapidfab:rapidfab-dev@postgres:5432/rapidfab
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - RUST_ENV=development
      - RUST_LOG=info
      - S3_ENDPOINT=${S3_ENDPOINT:-https://fsn1.your-objectstorage.com}
      - S3_BUCKET=${S3_BUCKET:-rapidfab}
      - S3_REGION=${S3_REGION:-eu-central-1}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-placeholder-access-key}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-placeholder-secret-key}
      - QUOTA_ANON_DAILY_MB=${QUOTA_ANON_DAILY_MB:-100}
      - QUOTA_USER_MONTHLY_GB=${QUOTA_USER_MONTHLY_GB:-10}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Upload Service
  upload:
    build:
      context: ./services/upload
      dockerfile: Containerfile
    environment:
      - DATABASE_URL=postgres://rapidfab:rapidfab-dev@postgres:5432/rapidfab
      - UPLOAD_HOST=0.0.0.0
      - UPLOAD_PORT=8082
      - S3_ENDPOINT=${S3_ENDPOINT:-https://fsn1.your-objectstorage.com}
      - S3_BUCKET=${S3_BUCKET:-rapidfab}
      - S3_REGION=${S3_REGION:-eu-central-1}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-placeholder-access-key}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-placeholder-secret-key}
      - UPLOAD_TICKET_SECRET=${UPLOAD_TICKET_SECRET:-dev-secret-change-in-prod}
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN:-dev-internal-token}
      - RUST_LOG=info
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres-data:
