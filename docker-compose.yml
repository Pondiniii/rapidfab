version: '3.8'

# Minimal stack for CI - fast, reliable, essential services only
# For full dev stack with observability: docker-compose -f docker-compose.minimal.yml -f docker-compose.obs.yml up

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: rapidfab
      POSTGRES_PASSWORD: rapidfab-dev
      POSTGRES_DB: rapidfab
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rapidfab"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # RapidFab API
  api:
    build:
      context: ./services/api
      dockerfile: Containerfile
    environment:
      - DATABASE_URL=postgres://rapidfab:rapidfab-dev@postgres:5432/rapidfab
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - RUST_ENV=development
      - RUST_LOG=info
      - S3_ENDPOINT=${S3_ENDPOINT:-https://fsn1.your-objectstorage.com}
      - S3_BUCKET=${S3_BUCKET:-rapidfab}
      - S3_REGION=${S3_REGION:-eu-central-1}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-placeholder-access-key}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-placeholder-secret-key}
      - QUOTA_ANON_DAILY_MB=${QUOTA_ANON_DAILY_MB:-100}
      - QUOTA_USER_MONTHLY_GB=${QUOTA_USER_MONTHLY_GB:-10}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Upload Service
  upload:
    build:
      context: ./services/upload
      dockerfile: Containerfile
    environment:
      - DATABASE_URL=postgres://rapidfab:rapidfab-dev@postgres:5432/rapidfab
      - UPLOAD_HOST=0.0.0.0
      - UPLOAD_PORT=8082
      - S3_ENDPOINT=${S3_ENDPOINT:-https://fsn1.your-objectstorage.com}
      - S3_BUCKET=${S3_BUCKET:-rapidfab}
      - S3_REGION=${S3_REGION:-eu-central-1}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-placeholder-access-key}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-placeholder-secret-key}
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT:-}
      - UPLOAD_TICKET_SECRET=${UPLOAD_TICKET_SECRET:-dev-secret-change-in-prod}
      - RUST_LOG=info
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 5

  # FDM Pricing Service
  pricing-fdm:
    build:
      context: ./services/pricing-fdm
      dockerfile: Containerfile
    environment:
      - PRICING_FDM_HOST=0.0.0.0
      - PRICING_FDM_PORT=8083
      - ORCA_PROFILES_DIR=/app/profiles
      - ORCA_BINARY=orca-slicer
      - TEMP_DIR=/tmp/pricing-fdm
      - BASE_FEE_USD=${BASE_FEE_USD:-5.00}
      - MACHINE_RATE_USD_PER_HOUR=${MACHINE_RATE_USD_PER_HOUR:-10.00}
      - MARGIN_MULTIPLIER=${MARGIN_MULTIPLIER:-1.30}
      - MATERIAL_PLA_COST_PER_G=${MATERIAL_PLA_COST_PER_G:-0.02}
      - MATERIAL_ABS_COST_PER_G=${MATERIAL_ABS_COST_PER_G:-0.025}
      - MATERIAL_PETG_COST_PER_G=${MATERIAL_PETG_COST_PER_G:-0.03}
      - MATERIAL_ABS_ESD_COST_PER_G=${MATERIAL_ABS_ESD_COST_PER_G:-0.035}
      - MATERIAL_ASA_COST_PER_G=${MATERIAL_ASA_COST_PER_G:-0.028}
      - MATERIAL_NYLON_COST_PER_G=${MATERIAL_NYLON_COST_PER_G:-0.04}
      - MATERIAL_PC_COST_PER_G=${MATERIAL_PC_COST_PER_G:-0.045}
      - MATERIAL_TPU_COST_PER_G=${MATERIAL_TPU_COST_PER_G:-0.035}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-100}
      - REQUEST_TIMEOUT_SECS=${REQUEST_TIMEOUT_SECS:-60}
      - RUST_LOG=info
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres-data:
