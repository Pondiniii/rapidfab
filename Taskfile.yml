version: '3'

# RapidFab.xyz Task-based CI Pipeline
# Usage: task ci (or just: task)
# Documentation: tests/CLAUDE.md

vars:
  API_DIR: services/api
  TESTS_DIR: tests
  E2E_DIR: tests/e2e

tasks:
  default:
    desc: Run full CI pipeline (default)
    cmds:
      - task: ci

  ci:
    desc: Full CI pipeline - run after agent work
    summary: |
      Runs complete CI pipeline:
      1. Stop Docker if running
      2. Format check (cargo fmt)
      3. Linter (cargo clippy)
      4. Unit tests (cargo test --lib)
      5. Build Docker images
      6. Deploy Docker stack
      7. Wait for services healthy
      8. E2E tests (auto-discovered from tests/e2e/*_test.sh)
      9. Cleanup Docker

      Exit code: 0 = all passed, non-zero = failures
      AGENTS CANNOT COMMIT IF THIS FAILS!
    cmds:
      - echo "ğŸš€ Full CI pipeline starting..."
      - echo "ğŸ³ Stopping Docker if running..."
      - docker-compose down 2>/dev/null || true
      - task: fmt
      - task: lint
      - task: test:unit
      - echo "ğŸ³ Building Docker images (with layer cache)..."
      - docker-compose build
      - echo "ğŸ³ Starting services..."
      - docker-compose up -d
      - task: docker:wait-healthy
      - task: test:e2e
      - echo "ğŸ³ Cleaning up Docker..."
      - docker-compose down -v
      - echo "âœ… CI passed - ready to commit"

  fmt:
    desc: Check code formatting
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ“ Checking code format..."
      - cargo fmt --all -- --check
      - echo "âœ… Format check passed"

  fmt:fix:
    desc: Auto-fix code formatting
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ“ Auto-fixing code format..."
      - cargo fmt --all
      - echo "âœ… Format fixed"

  lint:
    desc: Run linter (clippy)
    dir: "{{.API_DIR}}"
    env:
      SQLX_OFFLINE: "true"
    cmds:
      - echo "ğŸ” Running linter..."
      - cargo clippy --all-targets -- -D warnings
      - echo "âœ… Lint check passed"

  test:
    desc: Run Rust tests (unit + integration)
    dir: "{{.API_DIR}}"
    env:
      SQLX_OFFLINE: "true"
    cmds:
      - echo "ğŸ§ª Running Rust tests..."
      - cargo test --lib --bins
      - cargo test --test '*' -- --test-threads=1
      - echo "âœ… Rust tests passed"

  test:unit:
    desc: Run only unit tests
    dir: "{{.API_DIR}}"
    env:
      SQLX_OFFLINE: "true"
    cmds:
      - echo "ğŸ§ª Running unit tests..."
      - cargo test --lib --bins
      - echo "âœ… Unit tests passed"

  test:integration:
    desc: Run only integration tests
    dir: "{{.API_DIR}}"
    env:
      SQLX_OFFLINE: "true"
    cmds:
      - echo "ğŸ§ª Running integration tests..."
      - cargo test --test '*' -- --test-threads=1
      - echo "âœ… Integration tests passed"

  test:e2e:
    desc: Run E2E tests (auto-discovery)
    cmds:
      - echo "ğŸŒ Running E2E tests..."
      - ./scripts/test-e2e.sh
      - echo "âœ… E2E tests passed"

  build:
    desc: Build API in release mode
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ”¨ Building API (release mode)..."
      - cargo build --release
      - echo "âœ… Build complete"

  run:
    desc: Run API locally
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸš€ Starting API..."
      - RUST_LOG=info cargo run

  clean:
    desc: Clean build artifacts
    dir: "{{.API_DIR}}"
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - cargo clean
      - echo "âœ… Cleanup complete"

  docker:build:
    desc: Build Docker images
    cmds:
      - echo "ğŸ³ Building Docker images..."
      - docker-compose build
      - echo "âœ… Docker build complete"

  docker:up:
    desc: Start Docker services
    cmds:
      - echo "ğŸ³ Starting Docker services..."
      - docker-compose up -d
      - echo "âœ… Services started"

  docker:down:
    desc: Stop Docker services
    cmds:
      - echo "ğŸ³ Stopping Docker services..."
      - docker-compose down
      - echo "âœ… Services stopped"

  docker:wait-healthy:
    desc: Wait for services to be healthy
    cmds:
      - echo "â³ Waiting for API to be healthy..."
      - |
        TIMEOUT=60
        elapsed=0
        while [ $elapsed -lt $TIMEOUT ]; do
          if curl -sf http://localhost:8080/health/healthz > /dev/null 2>&1; then
            echo "âœ… API is healthy"
            exit 0
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "âŒ Timeout waiting for API"
        docker-compose logs api
        exit 1

  docker:ci:
    desc: Full CI with Docker (build + deploy + test + cleanup)
    cmds:
      - echo "ğŸ³ Running full Docker CI pipeline..."
      - ./scripts/test-pipeline.sh
      - echo "âœ… Docker CI passed"

  help:
    desc: Show available tasks
    cmds:
      - task --list
