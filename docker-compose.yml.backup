version: '3.8'

# RapidFab MVP - Complete Local Development Stack
# Start with: docker-compose up -d
# Monitor: docker-compose ps
# Debug DB: http://localhost:8081 (pgweb)

services:

  # ========================================
  # PostgreSQL 16 (Main database)
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: rapidfab_postgres
    environment:
      POSTGRES_DB: rapidfab
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c max_connections=200 -c log_statement=all"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - rapidfab

  # ========================================
  # pgweb (Database UI - for debugging)
  # ========================================
  pgweb:
    image: sosedoff/pgweb:latest
    container_name: rapidfab_pgweb
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-postgres}@postgres:5432/rapidfab?sslmode=disable
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rapidfab

  # ========================================
  # docker-mail-server (SMTP relay)
  # ========================================
#  mailserver:
#    image: ghcr.io/docker-mailserver/docker-mailserver:latest
#    container_name: rapidfab_mailserver
#    hostname: mail.rapidfab.local
#    domainname: rapidfab.local
#    environment:
#      MAIL_USER_CSV: admin@rapidfab.local|${MAIL_PASSWORD:-password}
#      MAIL_DOMAIN: rapidfab.local
#      MAIL_ADMIN_EMAIL: admin@rapidfab.local
#      ENABLE_AMAVIS: 1
#      ENABLE_FAIL2BAN: 0
#      ENABLE_SPAMASSASSIN: 0
#      SSL_TYPE: snakeoil
#      LOG_LEVEL: info
#    ports:
#      - "25:25"
#      - "587:587"
#      - "993:993"
#    volumes:
#      - mailserver_data:/var/mail
#      - mailserver_state:/var/mail-state
#      - mailserver_logs:/var/log/mail
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "sh", "-c", "nc -z localhost 25"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#    networks:
#      - rapidfab

  # ========================================
  # FastAPI Backend
  # ========================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: rapidfab_api
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD:-postgres}@postgres:5432/rapidfab
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispass}@redis:6379/0
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-prod}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_placeholder}
      S3_BUCKET: ${S3_BUCKET:-rapidfab-files}
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_PASSWORD:-minioadmin}
      SMTP_HOST: mailserver
      SMTP_PORT: 587
      SMTP_USER: admin@rapidfab.local
      SMTP_PASSWORD: ${MAIL_PASSWORD:-password}
      DEBUG: "true"
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailserver:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rapidfab
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # ========================================
  # Celery Worker (background jobs)
  # ========================================
  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: rapidfab_celery
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD:-postgres}@postgres:5432/rapidfab
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispass}@redis:6379/0
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-prod}
      SMTP_HOST: mailserver
      SMTP_PORT: 587
      SMTP_USER: admin@rapidfab.local
      SMTP_PASSWORD: ${MAIL_PASSWORD:-password}
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailserver:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rapidfab
    command: celery -A app.celery_worker worker --loglevel=info --concurrency=4

  # ========================================
  # SvelteKit Frontend
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: rapidfab_frontend
    environment:
      PUBLIC_API_URL: http://localhost:8000
      VITE_API_URL: http://localhost:8000
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rapidfab
    command: npm run dev

  # ========================================
  # MailHog (Email inspection - optional)
  # ========================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: rapidfab_mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    restart: unless-stopped
    networks:
      - rapidfab

# ========================================
# VOLUMES (Persistent data)
# ========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  mailserver_data:
    driver: local
  mailserver_state:
    driver: local
  mailserver_logs:
    driver: local

# ========================================
# NETWORKS (Service communication)
# ========================================
networks:
  rapidfab:
    driver: bridge
